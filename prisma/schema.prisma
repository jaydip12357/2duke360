generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  STUDENT
  DINING_STAFF
  FACILITIES
  ADMIN
}

enum ContainerStatus {
  AVAILABLE
  CHECKED_OUT
  IN_CLEANING
  LATE
  DAMAGED
  RETIRED
}

enum LocationType {
  DINING_HALL
  RETURN_STATION
}

model User {
  id           String   @id @default(cuid())
  email        String?  @unique
  name         String
  phone        String?
  netId        String?  @unique
  role         Role     @default(STUDENT)
  qrCode       String   @unique @default(cuid())
  passwordHash String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  currentContainers Container[]   @relation("CurrentUser")
  transactions      Transaction[]
  impactStats       ImpactStats?

  @@index([email])
  @@index([netId])
  @@index([qrCode])
}

model Container {
  id            String          @id @default(cuid())
  containerId   String          @unique // Human-readable ID like DRC-MKT-0001
  qrCode        String          @unique
  rfidTag       String?         @unique
  status        ContainerStatus @default(AVAILABLE)
  currentUserId String?
  dueDate       DateTime?
  locationId    String?
  checkoutCount Int             @default(0)
  condition     String          @default("Good")
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  // Relations
  currentUser  User?         @relation("CurrentUser", fields: [currentUserId], references: [id])
  location     Location?     @relation(fields: [locationId], references: [id])
  transactions Transaction[]

  @@index([containerId])
  @@index([qrCode])
  @@index([status])
  @@index([currentUserId])
}

model Transaction {
  id           String    @id @default(cuid())
  containerId  String
  userId       String
  checkoutTime DateTime  @default(now())
  returnTime   DateTime?
  locationId   String?
  wasLate      Boolean   @default(false)
  lateFee      Float?
  notes        String?
  createdAt    DateTime  @default(now())

  // Relations
  container Container @relation(fields: [containerId], references: [id])
  user      User      @relation(fields: [userId], references: [id])
  location  Location? @relation(fields: [locationId], references: [id])

  @@index([containerId])
  @@index([userId])
  @@index([checkoutTime])
}

model Location {
  id          String       @id @default(cuid())
  name        String       @unique
  code        String       @unique // Short code like MKT, WU, FARM
  type        LocationType @default(DINING_HALL)
  address     String?
  hours       String?      // JSON string of operating hours
  latitude    Float?
  longitude   Float?
  capacity    Int          @default(100)
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  containers   Container[]
  transactions Transaction[]

  @@index([code])
}

model ImpactStats {
  id                String   @id @default(cuid())
  userId            String   @unique
  containersReused  Int      @default(0)
  wasteAverted      Float    @default(0) // in lbs
  carbonSaved       Float    @default(0) // in kg CO2
  waterSaved        Float    @default(0) // in gallons
  streak            Int      @default(0) // consecutive on-time returns
  longestStreak     Int      @default(0)
  badges            String[] @default([])
  leaderboardRank   Int?
  lastUpdated       DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([containersReused])
  @@index([leaderboardRank])
}

model SystemSettings {
  id                    String   @id @default(cuid())
  lateFeeAmount         Float    @default(5.0)
  gracePeriodHours      Int      @default(24)
  returnWindowDays      Int      @default(3)
  maxContainersPerUser  Int      @default(5)
  autoChargeEnabled     Boolean  @default(false)
  smsNotificationsOn    Boolean  @default(true)
  emailNotificationsOn  Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // DUE_SOON, LATE, RETURN_CONFIRMED, ACHIEVEMENT
  title     String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([read])
}
